# 错误处理

## 错误类型

API使用统一的错误处理机制，定义了以下错误类型：

| 错误类型 | 枚举值 | HTTP状态码 | 说明 |
|----------|--------|------------|------|
| 验证错误 | VALIDATION_ERROR | 400 | 请求参数验证失败 |
| 不支持的语言 | UNSUPPORTED_LANGUAGE | 404 | 请求了不支持的编程语言 |
| 解析错误 | PARSE_ERROR | 422 | 代码解析失败 |
| 查询错误 | QUERY_ERROR | 422 | Tree-sitter查询语法错误 |
| 内存错误 | MEMORY_ERROR | 503 | 服务器内存不足 |
| 超时错误 | TIMEOUT_ERROR | 503 | 请求处理超时 |
| 内部错误 | INTERNAL_ERROR | 500 | 服务器内部错误 |
| 资源错误 | RESOURCE_ERROR | 503 | 服务器资源不足 |

## 错误响应格式

### 一般错误响应
```json
{
  "success": false,
  "errors": ["错误描述"],
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

### 详细错误响应
```json
{
  "success": false,
  "errors": ["错误描述"],
  "errorType": "VALIDATION_ERROR",
  "severity": "MEDIUM",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "requestId": "req_123456789",
  "recovery": {
    "attempted": true,
    "action": "cleanup",
    "message": "Memory cleanup performed"
  }
}
```

### 404错误响应
```json
{
  "success": false,
  "errors": ["Route GET /api/unknown not found"],
  "errorType": "VALIDATION_ERROR",
  "timestamp": "2024-01-15T10:30:00.000Z",
  "requestId": "req_123456789"
}
```

## 错误严重程度

| 严重程度 | 枚举值 | 说明 |
|----------|--------|------|
| 低 | LOW | 一般性错误，不影响系统运行 |
| 中 | MEDIUM | 需要关注的错误，可能影响部分功能 |
| 高 | HIGH | 严重错误，可能影响系统稳定性 |
| 危急 | CRITICAL | 危急错误，需要立即处理 |

## 常见错误及解决方案

### 1. VALIDATION_ERROR (400)

**原因**: 请求参数验证失败

**常见情况**:
- 缺少必需参数
- 参数格式不正确
- 参数值超出范围

**解决方案**:
- 检查请求体格式是否符合API规范
- 确保必需参数已提供
- 验证参数值是否在有效范围内

### 2. UNSUPPORTED_LANGUAGE (404)

**原因**: 请求了不支持的编程语言

**常见情况**:
- 语言标识符拼写错误
- 使用了不支持的编程语言

**解决方案**:
- 使用 `GET /api/languages` 获取支持的语言列表
- 确保语言标识符拼写正确

### 3. PARSE_ERROR (422)

**原因**: 代码解析失败

**常见情况**:
- 代码语法错误
- 代码格式不正确

**解决方案**:
- 检查代码语法是否正确
- 确保代码格式符合所选语言规范

### 4. QUERY_ERROR (422)

**原因**: Tree-sitter查询语法错误

**常见情况**:
- 查询语法错误
- 括号不匹配
- 缺少@符号

**解决方案**:
- 使用 `POST /api/parse/validate` 验证查询语法
- 检查查询语法是否符合Tree-sitter规范

### 5. MEMORY_ERROR (503)

**原因**: 服务器内存不足

**常见情况**:
- 处理大文件
- 并发请求过多

**解决方案**:
- 减少单次请求的代码量
- 降低并发请求数量
- 等待服务器内存释放

### 6. TIMEOUT_ERROR (503)

**原因**: 请求处理超时

**常见情况**:
- 处理复杂查询
- 服务器负载过高

**解决方案**:
- 简化查询语句
- 分批处理大文件
- 重试请求

## 错误恢复机制

API具有自动错误恢复机制，当发生错误时会尝试以下恢复操作：

1. **内存清理**: 当内存不足时自动清理未使用的资源
2. **资源回收**: 回收未使用的解析器实例
3. **重试机制**: 对于临时性错误尝试重试操作

## 开发环境错误详情

在开发环境中，错误响应可能包含以下额外信息：

```json
{
  "success": false,
  "errors": ["错误描述"],
  "details": {...},  // 详细错误信息
 "stack": "错误堆栈跟踪",  // 错误堆栈信息
  "timestamp": "2024-01-15T10:30:00.000Z"
}
```

## 最佳实践

1. **请求验证**: 在发送请求前验证参数格式
2. **错误处理**: 妥善处理各种错误响应
3. **重试策略**: 对于临时性错误实现重试逻辑
4. **监控告警**: 监控错误率和错误类型分布
5. **日志记录**: 记录错误信息用于调试和分析