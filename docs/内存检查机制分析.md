# Tree-sitter API 项目内存检查机制分析

## 概述

Tree-sitter API 是一个轻量级的 Tree-sitter 解析器服务，用于代码分析和解析。该项目实现了一套完整的内存监控和管理机制，以防止内存泄漏和过度使用内存导致的服务不可用。本文档详细分析了此内存检查机制的触发机制、检查间隔、配置参数和工作原理。

## 内存检查组件

### 1. MemoryMonitor 类

`MemoryMonitor` 类是项目内存监控的核心组件，主要负责：

- 定期监控内存使用情况
- 根据预设阈值判断内存状态
- 触发内存清理机制
- 提供内存使用统计信息
- 管理内存配置的动态刷新

### 2. ResourceCleaner 类

`ResourceCleaner` 类负责执行具体的内存清理操作，包括：

- 基础清理：强制垃圾回收 (GC)
- 激进清理：清理解析器池
- 紧急清理：清理所有缓存和资源并执行多次 GC

### 3. ResourceGuard 中间件

`resourceGuard` 中间件在请求处理过程中实施内存保护，防止新请求加重内存负担。

## 内存检查触发机制

### 1. 定时监控

- **监控间隔**：每 30 秒执行一次内存检查 (`METRICS_INTERVAL: 30000ms`)
- **配置刷新间隔**：每 5 分钟刷新一次内存配置 (`5 * 60 * 1000ms`)

### 2. 请求级检查

- **频率控制**：每 5 秒检查一次内存状态 (`memoryCheckInterval: 5000ms`)
- **条件触发**：在处理新请求时，如果距离上次内存检查超过 5 秒，则执行内存检查
- **应急触发**：当检测到内存状态为 "critical" 时，立即执行紧急清理

### 3. 响应完成检查

- 在响应完成后检查内存增长情况
- 如果内存增长超过 10MB，根据当前内存状态决定是否执行清理

### 4. 周期性健康检查

- **频率**：每小时执行一次健康检查 (`60 * 60 * 1000ms`)
- **内容**：检查内存使用情况和日志系统状态

## 内存阈值配置

根据环境变量和默认配置，内存阈值设定如下（默认值）：

- **警告阈值 (WARNING)**：200MB
- **严重阈值 (CRITICAL)**：300MB  
- **最大阈值 (MAXIMUM)**：不低于 350MB（计算公式为 `Math.max(criticalThreshold + 50, maxMemory * 0.9)`）

默认最大内存限制为 512MB (`MAX_MEMORY_MB: 512`)。

## 内存清理策略

### 1. 清理间隔配置

- **基础清理间隔**：每分钟执行一次 (`INTERVAL: 60000ms`)
- **强制 GC 间隔**：每 5 分钟执行一次 (`FORCE_GC_INTERVAL: 300000ms`)

### 2. 清理策略类型

- **基础 (BASIC)**：仅执行强制垃圾回收
- **激进 (AGGRESSIVE)**：清理解析器池并执行多次 GC
- **紧急 (EMERGENCY)**：清理所有缓存和资源并执行多次 GC

### 3. 清理触发条件

- 当内存状态为 "critical" 时，立即执行紧急清理
- 定期执行基础清理（根据 `INTERVAL` 配置）
- 在请求完成时检测到高内存增长时触发清理

## 内存监控集成点

### 1. 服务器启动

- 启动定时监控机制
- 设置配置刷新定时器
- 初始化定期健康检查

### 2. 请求处理中间件

- 在 `resourceGuard` 中间件中实施内存保护
- 检查并发请求数量
- 限制请求大小和代码长度
- 动态监控内存状态

### 3. 错误处理

- 在错误处理中整合内存监控
- 当发生错误时评估内存状态
- 在服务关闭时执行内存清理

## 内存配置管理

### 1. 环境变量配置

内存检查机制支持通过环境变量进行配置：

- `MAX_MEMORY_MB`: 最大内存限制 (默认: 512MB)
- `MEMORY_WARNING_THRESHOLD`: 内存警告阈值 (默认: 200MB)
- `MEMORY_CRITICAL_THRESHOLD`: 内存严重阈值 (默认: 300MB)
- `MAX_REQUEST_SIZE`: 最大请求大小 (默认: 5MB)

### 2. 动态配置刷新

内存配置支持在运行时动态刷新，系统每 5 分钟检查一次配置变化，无需重启服务即可应用新的内存阈值。

## 内存监控指标

系统监控以下内存指标：

- `heapUsed`: 已使用堆内存
- `heapTotal`: 堆内存总大小
- `rss`: 常驻集大小 (Resident Set Size)
- `external`: 外部内存使用量
- `arrayBuffers`: ArrayBuffer 内存使用量

## 总结

Tree-sitter API 项目的内存检查机制设计合理，通过多层次的监控和清理策略有效防止内存泄漏和过度使用。主要特点包括：

1. **多层防护**：结合定时监控、请求级检查和应急响应
2. **灵活配置**：支持环境变量配置和动态刷新
3. **分层清理**：根据内存状态严重程度采用不同清理策略
4. **实时响应**：在请求处理过程中实时监控内存状态
5. **资源保护**：限制请求大小、并发数等防止资源耗尽

这套机制确保了服务在长时间运行过程中的内存稳定性和可靠性。